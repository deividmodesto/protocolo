{% extends "base.html" %}
{% block title %}{{ title or 'Abrir Novo Protocolo' }}{% endblock %}
{% block content %}
    <h2>{{ title or 'Abrir Novo Protocolo' }}</h2>
    <form method="POST" action="" enctype="multipart/form-data">
        {{ form.hidden_tag() }}

        <div class="accordion" id="protocoloAccordion">

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingOne">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne">
                        1. Dados Principais do Protocolo
                    </button>
                </h2>
                <div id="collapseOne" class="accordion-collapse collapse show" data-bs-parent="#protocoloAccordion">
                    <div class="accordion-body">
                        <div class="row">
                            <div class="col-md-9 mb-3">
                                {{ form.assunto.label(class="form-label") }}
                                {{ form.assunto(class="form-control") }}
                            </div>
                            <div class="col-md-3 mb-3">
                                {{ form.data_vencimento.label(class="form-label") }}
                                {{ form.data_vencimento(class="form-control") }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.setor_destinatario.label(class="form-label") }}
                                {{ form.setor_destinatario(class="form-select") }}
                            </div>
                            
                            <div class="col-md-6 mb-3 position-relative">
                                <label for="fornecedor_busca" class="form-label">Fornecedor Associado (Opcional)</label>
                                <input type="text" id="fornecedor_busca" class="form-control" placeholder="Digite código ou nome para buscar..." value="{{ request.form.fornecedor_busca or (protocolo_existente.fornecedor_ext_nome if protocolo_existente else '') }}">
                                <input type="hidden" id="fornecedor_ext_cod_hidden" name="fornecedor_ext_cod" value="{{ request.form.fornecedor_ext_cod or (protocolo_existente.fornecedor_ext_cod if protocolo_existente else '') }}">
                                <input type="hidden" id="fornecedor_ext_nome_hidden" name="fornecedor_ext_nome" value="{{ request.form.fornecedor_ext_nome or (protocolo_existente.fornecedor_ext_nome if protocolo_existente else '') }}">
                                <div id="fornecedor_results" class="list-group position-absolute w-100" style="z-index: 1000; max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                         <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.colaborador_destinatario.label(class="form-label") }}
                                {{ form.colaborador_destinatario(class="form-select") }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingTwo">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseTwo">
                        2. Usar Modelo e Preencher Dados (Opcional)
                    </button>
                </h2>
                <div id="collapseTwo" class="accordion-collapse collapse" data-bs-parent="#protocoloAccordion">
                    <div class="accordion-body">
                        <div class="mb-3">
                            {{ form.modelo.label(class="form-label") }}
                            {{ form.modelo(class="form-select") }}
                        </div>
                        
                        <div id="tabela-dinamica-container" class="d-none mt-3">
                            <div class="table-responsive"> 
                                <table class="table table-bordered"> 
                                    <thead id="tabela-dinamica-head"></thead>
                                    <tbody id="tabela-dinamica-body"></tbody>
                                </table>
                            </div>
                            <button type="button" id="add-row-btn" class="btn btn-outline-success btn-sm">Adicionar Linha</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header" id="headingThree">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseThree">
                        3. Descrição Detalhada e Anexos
                    </button>
                </h2>
                <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#protocoloAccordion">
                    <div class="accordion-body">
                        <div class="mb-3 form-check">
                            {{ form.is_externo(class="form-check-input") }}
                            {{ form.is_externo.label(class="form-check-label") }}
                        </div>
                        <div class="mt-3">
                            {{ form.descricao.label(class="form-label") }}
                            {{ form.descricao(class="form-control", rows=5) }}
                        </div>
                        <div class="mt-3">
                            {{ form.anexos.label(class="form-label") }}
                            {{ form.anexos(class="form-control") }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-4 d-flex gap-2 justify-content-between align-items-center">
            <div class="d-flex gap-2">
                {# Botão Principal de Envio #}
                {{ form.submit(class="btn btn-primary btn-lg") }}
                
                {# Botão de Salvar Rascunho #}
                {{ form.submit_rascunho(class="btn btn-secondary btn-lg") }}
            </div>

            {# Botão de Excluir Rascunho (Visível apenas na edição) #}
            {% if protocolo_existente and protocolo_existente.status == 'Rascunho' %}
            <div>
                <button type="button" class="btn btn-outline-danger btn-lg" data-bs-toggle="modal" data-bs-target="#modalExcluirRascunho">
                    <i class="bi bi-trash"></i> Excluir Rascunho
                </button>
            </div>
            {% endif %}
        </div>
    </form>

    {# Modal de Confirmação de Exclusão #}
    {% if protocolo_existente %}
    <div class="modal fade" id="modalExcluirRascunho" tabindex="-1" aria-labelledby="modalExcluirLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="modalExcluirLabel">Confirmar Exclusão</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Tem certeza que deseja excluir este rascunho? Esta ação não pode ser desfeita.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <form action="{{ url_for('main.excluir_protocolo', protocolo_id=protocolo_existente.id) }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-danger">Excluir Definitivamente</button>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

{% endblock %}


{% block scripts %}
{{ super() }} {# Importante para manter os scripts do base.html #}

<script>
    // --- VARIÁVEIS GLOBAIS DE ESTADO ---
    let camposDoModelo = [];
    let rowCount = 0;
    let isRestoringDraft = false; // Flag para controlar o comportamento de adição de linhas

    // --- FUNÇÃO PRINCIPAL DE ADIÇÃO DE LINHAS ---
    function adicionarLinha() {
        const tbody = document.getElementById('tabela-dinamica-body');
        const newRow = tbody.insertRow();
        
        camposDoModelo.forEach(campo => {
            const newCell = newRow.insertCell();
            let input = document.createElement(campo.tipo_campo === 'area_de_texto' ? 'textarea' : 'input');
            
            if (input.tagName === 'TEXTAREA') {
                input.rows = 2;
                input.style.width = '300px';
            } else {
                const tipoInput = {'texto': 'text', 'numero': 'number', 'data': 'date'}[campo.tipo_campo] || 'text';
                input.type = tipoInput;
                input.style.width = '220px';
            }
            
            input.classList.add('form-control');
            // Importante: O nome precisa ser consistente para o WTForms ler
            input.name = `${campo.nome_campo}-${rowCount}`; 
            if (campo.obrigatorio) input.required = true;
            input.style.minWidth = input.style.width;
            
            newCell.appendChild(input);
        });

        const actionCell = newRow.insertCell();
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'Remover';
        removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
        removeBtn.onclick = function() { tbody.removeChild(newRow); };
        actionCell.appendChild(removeBtn);
        rowCount++;
    }

    // --- EVENTO: BOTÃO ADICIONAR LINHA ---
    document.getElementById('add-row-btn').addEventListener('click', adicionarLinha);

    // --- FUNÇÃO DE CARREGAMENTO DO MODELO ---
    async function carregarCamposModelo(modeloId) {
        const container = document.getElementById('tabela-dinamica-container');
        const thead = document.getElementById('tabela-dinamica-head');
        const tbody = document.getElementById('tabela-dinamica-body');
        
        // Reseta a tabela visualmente, mas mantém rowCount se for um append (não é o caso aqui)
        thead.innerHTML = '';
        tbody.innerHTML = '';
        rowCount = 0;

        if (!modeloId || modeloId === '0') {
            container.classList.add('d-none');
            camposDoModelo = [];
            return;
        }

        try {
            container.classList.remove('d-none');
            const response = await fetch(`/api/modelo/${modeloId}/campos`);
            const campos = await response.json();
            
            camposDoModelo = campos; // Atualiza estado global

            // Constrói o Cabeçalho
            const headerRow = thead.insertRow();
            campos.forEach(campo => {
                const th = document.createElement('th');
                th.textContent = campo.nome_campo;
                if (campo.obrigatorio) th.textContent += ' *';
                headerRow.appendChild(th);
            });
            const actionTh = document.createElement('th');
            actionTh.textContent = 'Ação';
            headerRow.appendChild(actionTh);

            return true; // Indica sucesso
        } catch (error) {
            console.error('Erro ao carregar campos do modelo:', error);
            return false;
        }
    }

    // --- EVENTO: MUDANÇA NO SELECT DE MODELO ---
    document.getElementById('modelo').addEventListener('change', function() {
        // Se estamos restaurando dados (via script abaixo), não adicionamos linha vazia
        // Se é uma mudança manual do usuário, adicionamos.
        const modeloId = this.value;
        
        carregarCamposModelo(modeloId).then(() => {
            // Apenas adiciona linha vazia se for interação do usuário
            if (!isRestoringDraft) {
                adicionarLinha();
            }
        });
    });

    // --- SCRIPT PARA FILTRAR COLABORADORES POR SETOR ---
    document.getElementById('setor_destinatario').addEventListener('change', function() {
        const setorId = this.value;
        const colabSelect = document.getElementById('colaborador_destinatario');
        const valorAtual = colabSelect.value; // Tenta preservar seleção em edição
        
        colabSelect.innerHTML = '<option value="0">--- Nenhum ---</option>';

        if (setorId) {
            fetch(`/api/setor/${setorId}/colaboradores`)
                .then(response => response.json())
                .then(colaboradores => {
                    colaboradores.forEach(colab => {
                        const option = document.createElement('option');
                        option.value = colab.id;
                        option.textContent = colab.nome;
                        colabSelect.appendChild(option);
                    });
                    
                    // Restaura valor se possível
                    if (valorAtual && valorAtual !== '0') {
                       const optionExists = [...colabSelect.options].some(o => o.value == valorAtual);
                       if (optionExists) colabSelect.value = valorAtual;
                    }
                });
        }
    });
    
    // --- AUTOCOMPLETE FORNECEDORES ---
    // (Mantido igual, apenas condensado para clareza)
    const fornecedorBuscaInput = document.getElementById('fornecedor_busca');
    const fornecedorResultsDiv = document.getElementById('fornecedor_results');
    let searchTimeout;

    fornecedorBuscaInput.addEventListener('input', function() {
        const term = this.value;
        clearTimeout(searchTimeout);
        fornecedorResultsDiv.innerHTML = '';
        if (term.length < 2) return;

        fornecedorResultsDiv.innerHTML = '<a class="list-group-item disabled">Buscando...</a>';
        searchTimeout = setTimeout(() => {
            fetch(`/api/buscar_fornecedores?term=${encodeURIComponent(term)}`)
                .then(r => r.json())
                .then(data => {
                    fornecedorResultsDiv.innerHTML = '';
                    if (data.length > 0) {
                        data.forEach(item => {
                            const a = document.createElement('a');
                            a.href = '#';
                            a.className = 'list-group-item list-group-item-action';
                            a.textContent = item.text;
                            a.onclick = (e) => {
                                e.preventDefault();
                                fornecedorBuscaInput.value = item.text;
                                document.getElementById('fornecedor_ext_cod_hidden').value = item.id;
                                document.getElementById('fornecedor_ext_nome_hidden').value = item.nome;
                                fornecedorResultsDiv.innerHTML = '';
                            };
                            fornecedorResultsDiv.appendChild(a);
                        });
                    } else {
                        fornecedorResultsDiv.innerHTML = '<a class="list-group-item disabled">Nenhum encontrado.</a>';
                    }
                });
        }, 300);
    });
    document.addEventListener('click', e => {
        if (!fornecedorBuscaInput.contains(e.target)) fornecedorResultsDiv.innerHTML = '';
    });

    // --- LÓGICA CRÍTICA: RESTAURAÇÃO DE DADOS DO SERVIDOR (EDIÇÃO) ---
    {% if protocolo_existente and protocolo_existente.dados_preenchidos %}
    document.addEventListener('DOMContentLoaded', async function() {
        isRestoringDraft = true; // Ativa modo de restauração para bloquear linha vazia automática
        
        const dadosServidor = {{ protocolo_existente.dados_preenchidos | tojson }};
        const modeloSelect = document.getElementById('modelo');
        const modeloId = modeloSelect.value;

        // Dispara carregamento de colaboradores (para garantir que o select esteja populado)
        document.getElementById('setor_destinatario').dispatchEvent(new Event('change'));

        if (modeloId && modeloId !== '0') {
            // 1. Aguarda o carregamento da estrutura da tabela
            await carregarCamposModelo(modeloId);
            
            // 2. Agora que camposDoModelo está populado, preenche os dados
            const tbody = document.getElementById('tabela-dinamica-body');
            
            dadosServidor.forEach((linha, index) => {
                adicionarLinha(); // Cria a linha HTML
                
                // Preenche os inputs dessa linha
                for (const [key, value] of Object.entries(linha)) {
                    if (!key.startsWith('_')) {
                        // Procura o input pelo nome gerado dinamicamente
                        // rowCount já foi incrementado, então a linha atual é rowCount-1
                        // Mas como o loop é sequencial e o index bate com a ordem de criação...
                        // O nome do input é `NomeCampo-Index`.
                        // Precisamos garantir que estamos pegando o input correto.
                        // A função adicionarLinha usa `rowCount`, que começa em 0.
                        
                        const inputName = `${key}-${index}`;
                        const input = document.getElementsByName(inputName)[0];
                        if (input) {
                            input.value = value;
                        }
                    }
                }
            });
        }
        
        isRestoringDraft = false; // Libera para uso normal
    });
    {% else %}
    // Se for novo protocolo, apenas dispara o evento de change para colaboradores
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('setor_destinatario').dispatchEvent(new Event('change'));
    });
    {% endif %}

    // --- LOCALSTORAGE (Segurança de Crash) ---
    // Mantido simplificado, só ativa se não for edição de servidor
    if (!window.location.pathname.includes('/editar')) {
        // ... (código localStorage existente se quiser manter, ou pode remover para simplificar) ...
    }
</script>
{% endblock %}